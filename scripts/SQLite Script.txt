-- $Source: unfiled
-- $Revision: 1 $
-- Author: Jim Busser
-- Info: importer for Canadian Drug Database data
-- into sqlite and FreeDiams

-- call this from the command line
-- (if not already chained from the fetch script) as:
-- sqlite3 -init create_dpd_db.sql dpd.db

.mode csv
.separator "|"

CREATE TABLE "drug" ("DRUG_CODE" INTEGER(8) PRIMARY KEY  NOT NULL , "PRODUCT_CATEGORIZATION" VARCHAR2(80), "CLASS" VARCHAR2(40), "DRUG_IDENTIFICATION_NUMBER" VARCHAR2(8), "BRAND_NAME" VARCHAR2(200), "PEDIATRIC_FLAG" VARCHAR2(1), "ACCESSION_NUMBER" VARCHAR2(5), "NUMBER_OF_AIS" VARCHAR2(10), "LAST_UPDATE_DATE" DATE, "AI_GROUP_NO" VARCHAR2(10));

CREATE TABLE "form" ("DRUG_CODE" INTEGER(8) NOT NULL , "PHARM_FORM_CODE" INTEGER(7), "PHARMACEUTICAL_FORM" VARCHAR2(40));

CREATE TABLE "route" ("DRUG_CODE" INTEGER(8)  NOT NULL , "ROUTE_OF_ADMINISTRATION_CODE" INTEGER(6), "ROUTE_OF_ADMINISTRATION" VARCHAR2(40));

CREATE  TABLE "status" ("DRUG_CODE" INTEGER(8)  NOT NULL , "CURRENT_STATUS_FLAG" VARCHAR2(1), "STATUS" VARCHAR2(40), "HISTORY_DATE" DATE);

CREATE TABLE "ingred" ("DRUG_CODE" INTEGER(8) NOT NULL , "ACTIVE_INGREDIENT_CODE" INTEGER(6), "INGREDIENT" VARCHAR2(240), "INGREDIENT_SUPPLIED_IND" VARCHAR2(1), "STRENGTH" VARCHAR2(20), "STRENGTH_UNIT" VARCHAR2(40), "STRENGTH_TYPE" VARCHAR2(40), "DOSAGE_VALUE" VARCHAR2(20), "BASE" VARCHAR2(1), "DOSAGE_UNIT" VARCHAR2(40), "NOTES" VARCHAR2(2000));

CREATE TABLE "ther" ("DRUG_CODE" INTEGER(8) NOT NULL , "TC_ATC_NUMBER" VARCHAR2(8), "TC_ATC" VARCHAR2(120), "TC_AHFS_NUMBER" VARCHAR2(20), "TC_AHFS" VARCHAR2(80));

CREATE TABLE "package" ("DRUG_CODE" INTEGER(8) NOT NULL , "UPC" VARCHAR2(12), "PACKAGE_SIZE_UNIT" VARCHAR2(40), "PACKAGE_TYPE" VARCHAR2(40), "PACKAGE_SIZE" VARCHAR2(5), "PRODUCT_INFORMATION" VARCHAR2(80));

.import drug.csv drug
.import form.csv form
.import route.csv route
.import status.csv status
.import ingred.csv ingred
.import ther.csv ther
.import package.csv package


-- Create FreeDiams tables and populate from DPD data

-- Table COMPO

CREATE TABLE "COMPO"(  `CIS` int(10) NOT NULL,  `NOM` varchar(100)  NOT NULL,  `CODE_SUBST` int(11) NOT NULL,  `DENOMINATION` varchar(200) NOT NULL,  `DOSAGE` varchar(100)  NOT NULL,  `REF_DOSAGE` varchar(50),  `NATURE` varchar(2),  `LK_NATURE` int(11));

INSERT INTO COMPO (CIS, NOM, CODE_SUBST, DENOMINATION, DOSAGE, REF_DOSAGE, NATURE, LK_NATURE)
SELECT A1.DRUG_CODE, A2.PHARMACEUTICAL_FORM, A1.ACTIVE_INGREDIENT_CODE, A1.INGREDIENT, A1.STRENGTH || A1.STRENGTH_UNIT || "/" || A1.DOSAGE_VALUE || A1.DOSAGE_UNIT,   "", "", ""
FROM ingred A1, form A2
WHERE A1.DRUG_CODE = A2.DRUG_CODE AND A1.DOSAGE_VALUE != "";
-- 4716 rows

INSERT INTO COMPO (CIS, NOM, CODE_SUBST, DENOMINATION, DOSAGE, REF_DOSAGE, NATURE, LK_NATURE)
SELECT A1.DRUG_CODE, A2.PHARMACEUTICAL_FORM, A1.ACTIVE_INGREDIENT_CODE, A1.INGREDIENT, A1.STRENGTH || A1.STRENGTH_UNIT,   "", "", ""
FROM ingred A1, form A2
WHERE A1.DRUG_CODE = A2.DRUG_CODE AND A1.DOSAGE_VALUE = "";
-- 3409 rows

CREATE TABLE `CIS_CIP` (  `CIS` int(11) NOT NULL,  `CIP` int(20),  `LIBELLE` varchar(500) NOT NULL,  `STATUT` varchar(100),  `COMMERCIALISATION` varchar(100),  `DATE_STR` varchar(10),  `CIP_LONG` int(20));

INSERT INTO CIS_CIP (CIS, LIBELLE)
SELECT DRUG_CODE, PRODUCT_INFORMATION
FROM package;

-- Table CIS
-- FIXME:
-- did not yet resolve how to populate FORME, ADMINISTRATION, COMMERCIALISATION
-- from non-unique values

CREATE TABLE `CIS` (  `CIS` int(11) NOT NULL,  `DENOMINATION` varchar(1000) NOT NULL,  `FORME` varchar(500),  `ADMINISTRATION` varchar(100),  `AMM` varchar(50),  `AUTORISATION` varchar(50),  `COMMERCIALISATION` varchar(50),  `CODE_RPC` int(10));

INSERT INTO CIS (CIS, DENOMINATION)
SELECT DRUG_CODE, BRAND_NAME
FROM drug;

-- Tables IAM_DENOMINATION and IAM_IMPORT, despite that Canada does not use them

CREATE TABLE `IAM_DENOMINATION` (`ID_DENOMINATION` int(10) NOT NULL ,`DENOMINATION` varchar( 200 ) NOT NULL);

CREATE TABLE `IAM_IMPORT` (`IAM_ID` INTEGER PRIMARY KEY,`ID1` int(10) NOT NULL ,`ID2` int(10) NOT NULL ,`TYPE` INT UNSIGNED NOT NULL ,`TEXT_IAM` VARCHAR( 2000 ) NULL ,`TEXT_CAT` VARCHAR( 2000 ) NULL );

-- uncomment the following to automatically drop the DPD staging tables
-- DROP TABLE drug;
-- DROP TABLE form;
-- DROP TABLE route;
-- DROP TABLE status;
-- DROP TABLE ingred;
-- DROP TABLE ther;
-- DROP TABLE package;


.exit